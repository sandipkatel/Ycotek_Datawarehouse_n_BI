CREATE DATABASE IOE;

CREATE SCHEMA IOE.LANDING;
CREATE SCHEMA IOE.STAGE;
CREATE SCHEMA IOE.TEMP;
CREATE SCHEMA IOE.TARGET;

-- STAGE TO DUMP FILES
CREATE STAGE IOE.LANDING.CSV_FILE
  FILE_FORMAT = (
    TYPE = CSV
    FIELD_DELIMITER = ','
    SKIP_HEADER = 1
    FIELD_OPTIONALLY_ENCLOSED_BY = '"'
  );

-- LANDING TABLES
CREATE
	OR REPLACE TABLE IOE.LANDING.SALES (
	ROW_ID VARCHAR
	,ORDER_ID VARCHAR
	,ORDER_DATE VARCHAR
	,SHIP_DATE VARCHAR
	,SHIP_MODE VARCHAR
	,CUSTOMER_ID VARCHAR
	,CUSTOMER_NAME VARCHAR
	,SEGMENT VARCHAR
	,COUNTRY VARCHAR
	,CITY VARCHAR
	,STATE VARCHAR
	,POSTAL_CODE VARCHAR
	,REGION VARCHAR
	,PRODUCT_ID VARCHAR
	,CATEGORY VARCHAR
	,SUB_CATEGORY VARCHAR
	,PRODUCT_NAME VARCHAR
	,SALES VARCHAR
	,QUANTITY VARCHAR
	,DISCOUNT VARCHAR
	,PROFIT VARCHAR
	);


-- Stage Dimension view (Transformation Views)
CREATE OR REPLACE VIEW STAGE.STG_D_CUSTOMER (
    CUSTOMER_ID
    ,CUSTOMER_NAME
    ,SEGMENT
) AS
SELECT
    TRIM(CUSTOMER_ID)
    ,TRIM(CUSTOMER_NAME)
    ,TRIM(SEGMENT)
FROM LANDING.SALES;

CREATE OR REPLACE VIEW STAGE.STG_D_PRODUCT (
     PRODUCT_ID
    ,PRODUCT_NAME
    ,CATEGORY
    ,SUB_CATEGORY
) AS
SELECT
    TRIM(PRODUCT_ID)
    ,TRIM(PRODUCT_NAME)
    ,TRIM(CATEGORY)
    ,TRIM(SUB_CATEGORY)
FROM LANDING.SALES;

CREATE OR REPLACE VIEW STAGE.STG_D_LOCATION (
     COUNTRY
    ,REGION
    ,STATE
    ,CITY
    ,POSTAL_CODE
) AS
SELECT
    TRIM(COUNTRY)
    ,TRIM(REGION)
    ,TRIM(STATE)
    ,TRIM(CITY)
    ,TRIM(POSTAL_CODE)
FROM LANDING.SALES;

CREATE OR REPLACE VIEW STAGE.STG_D_SHIP_MODE (
     SHIP_MODE
) AS
SELECT
    TRIM(SHIP_MODE)
FROM LANDING.SALES;

-- Stage FACT view (Transformation Views)
CREATE OR REPLACE VIEW STAGE.STG_F_SALES (
     customer_id
    ,product_id
    ,COUNTRY
    ,REGION
    ,STATE
    ,CITY
    ,POSTAL_CODE
    ,ORDER_DATE
    ,SHIP_DATE
    ,SHIP_MODE
    ,QUANTITY
    ,DISCOUNT
    ,REVENUE
    ,PROFIT
    ,COST
) AS
SELECT top 10
    TRIM(customer_id)
    ,TRIM(product_id)
    ,TRIM(COUNTRY)
    ,TRIM(REGION)
    ,TRIM(STATE)
    ,TRIM(CITY)
    ,TRIM(POSTAL_CODE)
    ,TO_DATE(ORDER_DATE, 'MM/DD/YYYY')
    ,TO_DATE(SHIP_DATE, 'MM/DD/YYYY')
    ,TRIM(SHIP_MODE)
    ,TRIM(QUANTITY)
    ,TRIM(DISCOUNT)
    ,TRIM(SALES)
    ,TRIM(PROFIT)
    ,(TRIM(SALES)::FLOAT - TRIM(PROFIT)::FLOAT) AS COST
FROM LANDING.SALES;

-- Temporary Table
CREATE OR REPLACE TABLE TEMP.TMP_D_CUSTOMER (
     CUSTOMER_ID VARCHAR
    ,CUSTOMER_NAME VARCHAR
    ,SEGMENT VARCHAR
);

CREATE OR REPLACE TABLE TEMP.TMP_D_PRODUCT (
     PRODUCT_ID VARCHAR
    ,PRODUCT_NAME VARCHAR
    ,CATEGORY VARCHAR
    ,SUB_CATEGORY VARCHAR
);

CREATE OR REPLACE TABLE TEMP.TMP_D_LOCATION (
     COUNTRY VARCHAR
    ,REGION VARCHAR
    ,STATE VARCHAR
    ,CITY VARCHAR
    ,POSTAL_CODE VARCHAR
);

CREATE OR REPLACE TABLE TEMP.TMP_D_SHIP_MODE (
     SHIP_MODE VARCHAR
);

-- Target Table
CREATE OR REPLACE TABLE TARGET.TGT_D_CUSTOMER (
    CUSTOMER_KEY  NUMBER AUTOINCREMENT PRIMARY KEY
    ,CUSTOMER_ID VARCHAR
    ,CUSTOMER_NAME VARCHAR
    ,SEGMENT VARCHAR
);

CREATE OR REPLACE TABLE TARGET.TGT_D_PRODUCT (
    PRODUCT_KEY  NUMBER AUTOINCREMENT PRIMARY KEY
    ,PRODUCT_ID VARCHAR
    ,PRODUCT_NAME VARCHAR
    ,CATEGORY VARCHAR
    ,SUB_CATEGORY VARCHAR
);

CREATE OR REPLACE TABLE TARGET.TGT_D_LOCATION (
    LOCATION_KEY  NUMBER AUTOINCREMENT PRIMARY KEY
    ,COUNTRY VARCHAR
    ,REGION VARCHAR
    ,STATE VARCHAR
    ,CITY VARCHAR
    ,POSTAL_CODE VARCHAR
);

CREATE OR REPLACE TABLE TARGET.TGT_D_SHIP_MODE (
    SHIP_MODE_KEY NUMBER AUTOINCREMENT PRIMARY KEY
    ,SHIP_MODE VARCHAR
);

CREATE OR REPLACE TABLE TARGET.TGT_D_DATE (
    DATE_KEY NUMBER PRIMARY KEY
    ,FULL_DATE DATE
    ,YEAR NUMBER
    ,QUARTER NUMBER
    ,MONTH NUMBER
    ,MONTH_NAME VARCHAR
    ,WEEK NUMBER
    ,DAY NUMBER
    ,DAY_OF_WEEK NUMBER
    ,DAY_NAME VARCHAR
    ,IS_WEEKEND BOOLEAN
);

-- Date fill query
SET start_date = '2022-01-01';
SET row_count = (SELECT DATEDIFF(DAY, '2022-01-01', '2026-12-31') + 1);

INSERT INTO TARGET.TGT_D_DATE
SELECT
    TO_NUMBER(TO_CHAR(d, 'YYYYMMDD')) AS date_key,
    d                                AS full_date,
    YEAR(d)                          AS year,
    QUARTER(d)                       AS quarter,
    MONTH(d)                         AS month,
    TO_CHAR(d, 'Mon')                AS month_name,
    WEEK(d)                          AS week,
    DAY(d)                           AS day,
    DAYOFWEEK(d)                     AS day_of_week,
    TO_CHAR(d, 'Dy')                 AS day_name,
    IFF(DAYOFWEEK(d) IN (0, 6), TRUE, FALSE) AS is_weekend
FROM (
    SELECT DATEADD(DAY, ROW_NUMBER() OVER (ORDER BY NULL) - 1, $start_date::DATE) AS d
    FROM TABLE(GENERATOR(ROWCOUNT => 2000))
)
WHERE d <= '2026-12-31'::DATE;